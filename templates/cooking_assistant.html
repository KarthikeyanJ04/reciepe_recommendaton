<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus Mode | Culin.ary</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;800&display=swap">
    <style>
        /* --- Focus Mode Specific Overrides --- */
        body {
            font-family: 'Inter', sans-serif;
            background: #ffffff;
            background: radial-gradient(circle at 50% 30%, #ffffff 0%, #f4f4f5 100%);
            color: #111;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden;
        }

        /* UI Variables */
        :root {
            --bg-card: rgba(255, 255, 255, 0.9);
            --border-light: rgba(0,0,0,0.08);
            --text-main: #111;
            --text-muted: #666;
            --radius-lg: 32px;
            --radius-pill: 100px;
            --shadow-card: 0 20px 40px rgba(0,0,0,0.04);
            --accent: #000;
        }

        .focus-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding-bottom: 60px;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        /* Avatar Canvas */
        #avatar-container {
            width: 320px;
            height: 320px;
            margin-bottom: 10px;
            position: relative;
        }
        
        canvas {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 20px 30px rgba(0,0,0,0.08));
        }

        /* Step Progress Bar */
        .step-progress {
            display: flex;
            gap: 8px;
            margin-bottom: 40px;
            width: 100%;
            justify-content: center;
            padding: 0 20px;
        }
        
        .progress-dash {
            height: 4px;
            flex: 1;
            background: #e0e0e0;
            border-radius: 4px;
            transition: all 0.4s ease;
            max-width: 40px;
        }
        
        .progress-dash.active { background: #111; transform: scaleY(1.5); }
        .progress-dash.completed { background: #666; }

        /* Focus Card */
        .focus-card {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: 50px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow-card);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            transition: all 0.3s ease;
        }

        .step-title {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-muted);
            margin-bottom: 20px;
            font-weight: 700;
        }

        .instruction-text {
            font-size: 1.6rem;
            line-height: 1.4;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 40px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Timer Styles */
        .timer-display {
            font-size: 4rem;
            font-weight: 800;
            font-variant-numeric: tabular-nums;
            margin: 20px 0;
            display: none;
            color: var(--text-main);
            letter-spacing: -2px;
        }
        .timer-display.active { display: block; animation: slideUp 0.5s ease; }

        /* Controls */
        .controls-row {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn-focus {
            padding: 16px 32px;
            border-radius: var(--radius-pill);
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .btn-primary {
            background: #111;
            color: #fff;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
        
        .btn-secondary {
            background: transparent;
            color: #111;
            border-color: #e5e5e5;
        }
        .btn-secondary:hover { border-color: #111; }

        /* Header & Theme Toggle Overlay */
        .header-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
        }
        .header-overlay > * { pointer-events: auto; }
        
        .logo { font-weight: 800; font-size: 1.2rem; cursor: pointer; color: #111; }
        
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; } }
    </style>
</head>
<body>
    
    <div class="header-overlay">
        <div class="logo" onclick="window.location.href='/'">Culin.ary</div>
    </div>

    <div class="focus-container">
        <!-- Avatar -->
        <div id="avatar-container">
            <canvas id="avatarCanvas"></canvas>
        </div>

        <!-- Progress -->
        <div class="step-progress" id="progressBar"></div>

        <!-- Content Card -->
        <div class="focus-card">
            <div class="step-title" id="stepLabel">Initializing</div>
            <div class="instruction-text" id="instructionText">Connecting to AI Assistant...</div>
            <div class="timer-display" id="timerDisplay">00:00</div>
            
            <div class="controls-row">
                <button id="actionBtn" class="btn-focus btn-primary">Start Cooking</button>
                <button id="secBtn" class="btn-focus btn-secondary" style="display:none">Pause</button>
            </div>
        </div>
    </div>

    <script>
    (function() {
        // --- AVATAR ENGINE (2D Canvas) ---
        const canvas = document.getElementById('avatarCanvas');
        const ctx = canvas.getContext('2d');
        
        // Retina display setup
        const dpr = window.devicePixelRatio || 1;
        let rect = canvas.getBoundingClientRect();
        
        function resize() {
            rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
        }
        window.addEventListener('resize', resize);
        resize(); // Init

        // Animation State
        let time = 0;
        let isSpeaking = false;
        let blinkState = 0;
        let blinkTimer = 0;

        // Avatar Loop
        function draw() {
            const w = rect.width;
            const h = rect.height;
            const cx = w / 2;
            const cy = h / 2;
            
            ctx.clearRect(0, 0, w, h);
            
            time += 0.05;
            
            // Float Animation
            const hoverY = Math.sin(time * 0.05) * 5;
            const currentCy = cy + hoverY;

            // Drawing Configuration
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            // 1. Back Hair
            ctx.fillStyle = '#1a1a1a';
            ctx.beginPath();
            ctx.arc(cx, currentCy + 10, 90, Math.PI, 0, false);
            ctx.bezierCurveTo(cx + 90, currentCy + 130, cx - 90, currentCy + 130, cx - 90, currentCy + 10);
            ctx.fill();

            // 2. Neck
            ctx.fillStyle = '#ffeadd';
            ctx.fillRect(cx - 15, currentCy + 50, 30, 40);
            // Neck Shadow
            ctx.fillStyle = 'rgba(0,0,0,0.05)';
            ctx.fillRect(cx - 15, currentCy + 50, 30, 12);

            // 3. Clothes (Black Turtleneck)
            ctx.fillStyle = '#111';
            ctx.beginPath();
            ctx.ellipse(cx, currentCy + 140, 55, 60, 0, 0, Math.PI * 2);
            ctx.fill();

            // 4. Face
            ctx.fillStyle = '#ffeadd';
            ctx.beginPath();
            // Jawline
            ctx.moveTo(cx - 52, currentCy - 20);
            ctx.bezierCurveTo(cx - 52, currentCy + 60, cx - 20, currentCy + 85, cx, currentCy + 85);
            ctx.bezierCurveTo(cx + 20, currentCy + 85, cx + 52, currentCy + 60, cx + 52, currentCy - 20);
            // Forehead
            ctx.bezierCurveTo(cx + 52, currentCy - 70, cx - 52, currentCy - 70, cx - 52, currentCy - 20);
            ctx.fill();

            // 5. Eyes
            updateBlink();
            const eyeY = currentCy + 5;
            drawEye(cx - 24, eyeY, blinkState); // Left
            drawEye(cx + 24, eyeY, blinkState); // Right

            // 6. Mouth
            const mouthY = currentCy + 45;
            ctx.fillStyle = '#d48b8b';
            ctx.beginPath();
            if (isSpeaking) {
                // Talking animation
                const open = 5 + Math.sin(time * 0.8) * 4;
                ctx.ellipse(cx, mouthY, 8, open, 0, 0, Math.PI*2);
                ctx.fill();
            } else {
                // Smile
                ctx.strokeStyle = '#c57a7a';
                ctx.lineWidth = 2.5;
                ctx.arc(cx, mouthY - 2, 8, 0.2, Math.PI - 0.2);
                ctx.stroke();
            }

            // 7. Blush
            ctx.fillStyle = 'rgba(255, 100, 100, 0.1)';
            ctx.beginPath();
            ctx.ellipse(cx - 35, currentCy + 25, 10, 6, 0, 0, Math.PI*2);
            ctx.ellipse(cx + 35, currentCy + 25, 10, 6, 0, 0, Math.PI*2);
            ctx.fill();

            // 8. Front Hair (Bangs)
            ctx.fillStyle = '#1a1a1a';
            ctx.beginPath();
            ctx.moveTo(cx - 55, currentCy - 30);
            ctx.quadraticCurveTo(cx - 20, currentCy + 10, cx, currentCy - 15);
            ctx.quadraticCurveTo(cx + 20, currentCy + 10, cx + 55, currentCy - 30);
            ctx.bezierCurveTo(cx + 50, currentCy - 80, cx - 50, currentCy - 80, cx - 55, currentCy - 30);
            ctx.fill();

            requestAnimationFrame(draw);
        }

        function drawEye(x, y, state) {
            if (state === 2 || state === 1 || state === 3) {
                // Blink (Line)
                ctx.strokeStyle = '#111';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(x - 9, y + 2);
                ctx.quadraticCurveTo(x, y + 6, x + 9, y + 2);
                ctx.stroke();
            } else {
                // Open (Circle)
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.ellipse(x, y, 11, 10, 0, 0, Math.PI*2);
                ctx.fill();
                
                // Iris
                ctx.fillStyle = '#333';
                ctx.beginPath();
                ctx.arc(x, y, 6, 0, Math.PI*2);
                ctx.fill();

                // Highlight
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.arc(x - 3, y - 3, 2.5, 0, Math.PI*2);
                ctx.fill();
                
                // Lash
                ctx.strokeStyle = '#111';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(x - 11, y - 4);
                ctx.quadraticCurveTo(x, y - 9, x + 11, y - 2);
                ctx.stroke();
            }
        }

        function updateBlink() {
            if (blinkState === 0 && Math.random() > 0.99) blinkState = 1;
            if (blinkState > 0) {
                blinkTimer++;
                if (blinkTimer > 3) {
                    blinkTimer = 0;
                    blinkState = (blinkState + 1) % 4;
                }
            }
        }

        // Start Avatar Loop immediately
        draw();


        // --- APP LOGIC ---
        let steps = [];
        let currentStepIdx = -1;
        let timerInterval;
        let timeLeft;
        let isPaused = false;

        function speak(text) {
            if(!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            
            const u = new SpeechSynthesisUtterance(text);
            u.rate = 1.0;
            const voices = window.speechSynthesis.getVoices();
            const preferred = voices.find(v => v.name.includes('Google US English') || v.name.includes('Samantha'));
            if(preferred) u.voice = preferred;

            u.onstart = () => { isSpeaking = true; };
            u.onend = () => { isSpeaking = false; };
            u.onerror = () => { isSpeaking = false; };
            
            window.speechSynthesis.speak(u);
        }

        // --- MAIN LOAD LOGIC (Updated for Demo Mode) ---
        async function loadRecipeData() {
            const id = new URLSearchParams(location.search).get('recipe_id');
            
            // 1. DEMO MODE (If no ID found)
            if(!id) {
                console.log("No Recipe ID. Loading Demo Mode.");
                const demoData = {
                    recipe: { name: "Demo: Truffle Pasta" },
                    parsed_steps: [
                        { step_number: 1, text: "Bring a large pot of salted water to a boil.", has_timer: false, timers: [] },
                        { step_number: 2, text: "Add pasta and cook for 10 minutes until al dente.", has_timer: true, timers: [10] },
                        { step_number: 3, text: "Reserve 1 cup of pasta water, then drain the pasta.", has_timer: false, timers: [] },
                        { step_number: 4, text: "Mix pasta with truffle oil and parmesan, adding water to bind.", has_timer: false, timers: [] }
                    ]
                };
                initSession(demoData);
                return;
            }

            // 2. FETCH REAL DATA
            try {
                const res = await fetch('/cook-with-ai', { 
                    method: 'POST', 
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({recipe_id: id})
                });
                
                const data = await res.json();
                
                if(data.success) {
                    initSession(data);
                } else {
                    document.getElementById('instructionText').innerText = "Error: Could not find recipe.";
                }
            } catch(e) {
                document.getElementById('instructionText').innerText = "Connection Error. Please try again.";
                console.error(e);
            }
        }

        function initSession(data) {
            steps = data.parsed_steps;
            document.getElementById('stepLabel').innerText = data.recipe.name;
            document.getElementById('instructionText').innerText = "I'm ready to help you cook!";
            
            // Setup Progress Bars
            const bar = document.getElementById('progressBar');
            bar.innerHTML = '';
            steps.forEach(() => {
                const d = document.createElement('div');
                d.className = 'progress-dash';
                bar.appendChild(d);
            });

            // Pre-load voices
            window.speechSynthesis.getVoices();
            setTimeout(() => speak(`I've loaded the steps for ${data.recipe.name}. Click Start when ready.`), 500);
        }

        function updateUI(idx) {
            document.querySelectorAll('.progress-dash').forEach((d, i) => {
                d.className = 'progress-dash';
                if (i < idx) d.classList.add('completed');
                if (i === idx) d.classList.add('active');
            });
        }

        function nextStep() {
            clearInterval(timerInterval);
            document.getElementById('timerDisplay').classList.remove('active');
            document.getElementById('secBtn').style.display = 'none';

            currentStepIdx++;

            if (currentStepIdx >= steps.length) {
                document.getElementById('stepLabel').innerText = "FINISHED";
                document.getElementById('instructionText').innerText = "Bon Appétit!";
                document.getElementById('actionBtn').style.display = 'none';
                document.querySelectorAll('.progress-dash').forEach(d => d.classList.add('completed'));
                speak("All done. Enjoy your meal!");
                return;
            }

            updateUI(currentStepIdx);
            const step = steps[currentStepIdx];
            
            document.getElementById('stepLabel').innerText = `STEP ${step.step_number}`;
            document.getElementById('instructionText').innerText = step.text;
            speak(step.text);

            if (step.has_timer && step.timers.length > 0) {
                setupTimer(step.timers[0]);
            }
        }

        function setupTimer(mins) {
            timeLeft = mins * 60;
            const display = document.getElementById('timerDisplay');
            const secBtn = document.getElementById('secBtn');
            
            display.classList.add('active');
            updateTimerText();
            
            secBtn.style.display = 'block';
            secBtn.innerText = "Start Timer";
            secBtn.onclick = toggleTimer;
        }

        function toggleTimer() {
            const secBtn = document.getElementById('secBtn');
            if (!timerInterval || isPaused) {
                // Start/Resume
                isPaused = false;
                secBtn.innerText = "Pause";
                timerInterval = setInterval(tick, 1000);
            } else {
                // Pause
                isPaused = true;
                secBtn.innerText = "Resume";
                clearInterval(timerInterval);
            }
        }

        function tick() {
            timeLeft--;
            updateTimerText();
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                speak("Timer finished!");
                document.getElementById('secBtn').style.display = 'none';
            }
        }

        function updateTimerText() {
            const m = Math.floor(timeLeft / 60);
            const s = timeLeft % 60;
            document.getElementById('timerDisplay').innerText = `${m}:${s.toString().padStart(2,'0')}`;
        }

        // Initial Bindings
        document.getElementById('actionBtn').onclick = () => {
            document.getElementById('actionBtn').onclick = nextStep;
            document.getElementById('actionBtn').innerText = "Next Step";
            nextStep();
        };

        // Run
        loadRecipeData();

    })();
    </script>
</body>
</html>