<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>3D Cooking Assistant</title>
    <style>
        body{margin:0;font-family:Segoe UI,Arial,Helvetica,sans-serif;background:#f4f6fb}
        #app{max-width:1000px;margin:24px auto;padding:12px}
        .top{display:flex;gap:16px;align-items:center}
        #canvasWrap{width:360px;height:360px;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.08);display:flex;align-items:center;justify-content:center}
        .info{flex:1}
        .speech-bubble{background:#fff;padding:12px;border-radius:10px;border-left:4px solid #4b6ef6;min-height:72px}
        .controls{margin-top:12px;display:flex;gap:8px}
        .btn{padding:10px 14px;border-radius:8px;border:none;background:#4b6ef6;color:#fff;cursor:pointer}
        .btn.secondary{background:#66778a}
        .steps{margin-top:12px}
        .step{background:#fff;padding:10px;border-radius:8px;margin:8px 0}
        .mic{width:44px;height:44px;border-radius:50%;background:#ff6b6b;color:#fff;display:inline-flex;align-items:center;justify-content:center;border:none}
        #queryInput{width:100%;padding:8px;border-radius:8px;border:1px solid #ddd}
    </style>
</head>
<body>
<div id="app">
    <div class="top">
        <div id="canvasWrap"></div>
        <div class="info">
            <h2 id="recipeTitle">Recipe</h2>
            <div class="speech-bubble" id="speechBubble">Hello â€” I'm your 3D chef. I will guide you.</div>
            <div class="controls">
                <button class="btn" id="startBtn">Start Cooking</button>
                <button class="btn secondary" id="nextBtn" disabled>Next</button>
                <button class="btn secondary" id="pauseBtn" style="display:none">Pause</button>
                <button class="mic" id="micBtn">ðŸŽ¤</button>
            </div>
            <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
                <input id="queryInput" placeholder="Ask a question (e.g. 'what can I prep while rice cooks?')">
                <button class="btn" id="askBtn">Ask</button>
            </div>
        </div>
    </div>

    <div class="steps" id="stepsContainer"></div>
</div>

<!-- three.js from CDN -->
<script src="https://cdn.jsdelivr.net/npm/three@0.151.3/build/three.min.js"></script>
<script>
// Procedural 3D avatar (simple head + eyes + mouth) and glue to TTS + recipe flow
let scene, camera, renderer, head, leftEye, rightEye, mouth;
let speaking = false;
function init3D() {
    const wrap = document.getElementById('canvasWrap');
    renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(wrap.clientWidth, wrap.clientHeight);
    renderer.setClearColor(0xffffff,1);
    wrap.appendChild(renderer.domElement);
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(50, wrap.clientWidth/wrap.clientHeight, 0.1, 1000);
    camera.position.set(0,0,5);

    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(5,5,5);
    scene.add(light);
    const amb = new THREE.AmbientLight(0xffffff,0.6);
    scene.add(amb);

    // head
    const geo = new THREE.SphereGeometry(1.2, 32, 32);
    const mat = new THREE.MeshStandardMaterial({color:0xffe0bd, roughness:0.7});
    head = new THREE.Mesh(geo, mat);
    scene.add(head);

    // eyes
    const eyeGeo = new THREE.SphereGeometry(0.15, 16,16);
    const eyeMat = new THREE.MeshStandardMaterial({color:0x000000});
    leftEye = new THREE.Mesh(eyeGeo, eyeMat);
    rightEye = new THREE.Mesh(eyeGeo, eyeMat);
    leftEye.position.set(-0.45,0.2,1.05);
    rightEye.position.set(0.45,0.2,1.05);
    scene.add(leftEye); scene.add(rightEye);

    // mouth (plane that scales on Y)
    const mouthGeo = new THREE.PlaneGeometry(0.7,0.2);
    const mouthMat = new THREE.MeshStandardMaterial({color:0x7a1f1f});
    mouth = new THREE.Mesh(mouthGeo, mouthMat);
    mouth.position.set(0,-0.5,1.03);
    scene.add(mouth);

    animate();
}

function animate(){
    requestAnimationFrame(animate);
    // idle micro moves
    const t = Date.now()*0.001;
    head.rotation.y = Math.sin(t*0.3)*0.05;
    leftEye.position.y = 0.2 + Math.sin(t*1.4)*0.01;
    rightEye.position.y = 0.2 + Math.cos(t*1.2)*0.01;
    // mouth breathing when speaking
    if (speaking) {
        const scale = 1 + Math.abs(Math.sin(t*12))*0.9;
        mouth.scale.y = scale;
    } else {
        mouth.scale.y = 0.2;
    }
    renderer.render(scene, camera);
}

init3D();

// Cooking flow: reuse /cook-with-ai endpoint
let steps = [], currentStep = 0, timerInterval=null, remainingSeconds=0, isPaused=false, recipe=null;
const speechBubble = document.getElementById('speechBubble');
const stepsContainer = document.getElementById('stepsContainer');

async function loadRecipe(recipeId){
    try{
        const res = await fetch('/cook-with-ai', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({recipe_id:parseInt(recipeId)})});
        const data = await res.json();
        if(data.success){
            recipe = data.recipe; steps = data.parsed_steps;
            document.getElementById('recipeTitle').textContent = recipe.name;
            renderSteps();
            say(`Loaded ${recipe.name}. Press Start Cooking to begin.`);
        } else { say('Failed to load recipe.'); }
    }catch(e){console.error(e); say('Error loading recipe');}
}

function renderSteps(){
    stepsContainer.innerHTML = steps.map((s,i)=>`<div class="step"> <strong>Step ${s.step_number}</strong><div>${s.text}</div>${s.has_timer?'<div style="color:#b43">Timer: '+s.timers.join(', ')+' min</div>':''}</div>`).join('');
}

function say(text){
    speechBubble.textContent = text;
    // speak and animate avatar
    if('speechSynthesis' in window){
        const u = new SpeechSynthesisUtterance(text);
        u.rate = 0.95; u.pitch=1.0;
        u.onstart = ()=>{ speaking=true; };
        u.onend = ()=>{ speaking=false; };
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
    }
}

function startCooking(){
    document.getElementById('startBtn').disabled=true; document.getElementById('nextBtn').disabled=false;
    currentStep=0; nextStep();
}

function nextStep(){
    if(currentStep>=steps.length){ say('All done â€” enjoy your meal!'); return; }
    // highlight
    const els = document.querySelectorAll('.step'); els.forEach((el,i)=>el.style.borderLeft='3px solid transparent');
    const curEl = document.getElementById('stepsContainer').children[currentStep];
    if(curEl) curEl.style.borderLeft='3px solid #4b6ef6';
    const s = steps[currentStep];
    say(s.text);
    if(s.has_timer && s.timers && s.timers.length>0){ startTimer(s.timers[0]); }
    else { currentStep++; }
}

function startTimer(minutes){
    remainingSeconds = Math.floor(minutes*60);
    document.getElementById('pauseBtn').style.display='inline-block';
    document.getElementById('nextBtn').disabled = true;
    say(`Starting timer for ${minutes} minute${minutes>1?'s':''}`);
    timerInterval = setInterval(()=>{
        if(!isPaused){ remainingSeconds--; updateTimerDisplay(); if(remainingSeconds<=0){ clearInterval(timerInterval); say('Timer finished'); document.getElementById('nextBtn').disabled=false; document.getElementById('pauseBtn').style.display='none'; currentStep++; } }
    },1000);
}
function updateTimerDisplay(){
    const mins=Math.floor(remainingSeconds/60); const secs=remainingSeconds%60;
    speechBubble.textContent = `Time left: ${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
}

// Voice recognition (Chrome only)
let recognizing=false, recognition=null;
if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SR();
    recognition.lang='en-US'; recognition.interimResults=false;
    recognition.onresult = (e)=>{
        const text = e.results[0][0].transcript.trim();
        handleVoiceCommand(text);
    };
    recognition.onend = ()=>{ recognizing=false; document.getElementById('micBtn').textContent='ðŸŽ¤'; }
}

function handleVoiceCommand(text){
    const t = text.toLowerCase();
    if(t.includes('start')) startCooking();
    else if(t.includes('next') || t.includes('done')) nextStep();
    else if(t.includes('pause')){ isPaused=true; window.speechSynthesis.cancel(); say('Paused'); }
    else if(t.includes('resume')){ isPaused=false; say('Resumed'); }
    else { // treat as question -> call local-llm
        askQuestion(text);
    }
}

async function askQuestion(q){
    // send recipe context + query to /local-llm
    const payload = { query: q, recipe: { name: recipe?.name, ingredients: recipe?.ingredients, current_step: (steps[currentStep]?.text || '') } };
    try{
        const res = await fetch('/local-llm', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
        const data = await res.json();
        if(data.success){ say(data.answer); } else { say(data.error || 'No answer available'); }
    }catch(e){ console.error(e); say('Local LLM error or not configured'); }
}

// UI bindings
document.getElementById('startBtn').addEventListener('click', startCooking);
document.getElementById('nextBtn').addEventListener('click', ()=>{ nextStep(); });
document.getElementById('pauseBtn').addEventListener('click', ()=>{ isPaused=!isPaused; document.getElementById('pauseBtn').textContent = isPaused? 'Resume':'Pause'; });
document.getElementById('micBtn').addEventListener('click', ()=>{
    if(!recognition) { alert('SpeechRecognition not supported in this browser. Use Chrome.'); return; }
    if(!recognizing){ recognition.start(); recognizing=true; document.getElementById('micBtn').textContent='ðŸŽ™ï¸'; }
    else { recognition.stop(); recognizing=false; document.getElementById('micBtn').textContent='ðŸŽ¤'; }
});

document.getElementById('askBtn').addEventListener('click', ()=>{ const q=document.getElementById('queryInput').value.trim(); if(q) askQuestion(q); });

// attempt load recipe id from query param
const urlParams = new URLSearchParams(window.location.search);
const rid = urlParams.get('recipe_id') || urlParams.get('id') || 1;
loadRecipe(rid);
</script>
</body>
</html>
