<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Cooking Assistant</title>
    <style>
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea, #764ba2); min-height: 100vh; padding: 20px; margin: 0; }
        .cooking-assistant { max-width: 800px; margin: 0 auto; background: white; border-radius: 15px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .ai-avatar { text-align: center; margin-bottom: 30px; }
        .avatar-image { font-size: 80px; margin: 20px 0; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .avatar-speaking { animation: speak 0.5s; }
        @keyframes speak { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        h2 { color: #333; margin: 10px 0; }
        .speech-bubble { background: #f5f5f5; padding: 20px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #667eea; min-height: 60px; line-height: 1.5; }
        
        .steps-carousel-wrapper { overflow: hidden; position: relative; width: 100%; margin: 20px 0; }
        #stepsContainer { display: flex; transition: transform 0.5s ease-in-out; }

        .step-item {
            background: #f9f9f9;
            padding: 30px;
            margin: 0;
            border-radius: 15px;
            border: 1px solid #ddd;
            width: 100%;
            flex-shrink: 0;
            box-sizing: border-box;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 1.2em;
        }
        .step-number { font-weight: bold; color: #667eea; margin-bottom: 15px; font-size: 1.5em; }
        .timer-badge { display: inline-block; background: #ff6b6b; color: white; padding: 5px 15px; border-radius: 20px; font-size: 1em; margin-bottom: 20px; }
        .step-timer { font-size: 4em; font-weight: bold; color: #ff6b6b; font-family: monospace; margin-top: 20px; }

        .controls { display: flex; gap: 10px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
        .control-btn { padding: 12px 25px; border: none; border-radius: 20px; font-size: 15px; cursor: pointer; background: linear-gradient(135deg, #667eea, #764ba2); color: white; transition: 0.3s; }
        .control-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,0.4); }
        .control-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .recipe-title { font-size: 24px; font-weight: bold; color: #333; text-align: center; margin: 15px 0; }
        .loading { text-align: center; padding: 40px; color: #667eea; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="cooking-assistant">
        <div class="ai-avatar">
            <div class="avatar-image" id="avatar">üë®‚Äçüç≥</div>
            <h2>Chef AI</h2>
        </div>
        <div id="loadingIndicator" class="loading" style="display: none;">
            <div>Loading recipe...</div>
            <div class="spinner"></div>
        </div>
        <div id="contentArea" style="display: none;">
            <h1 class="recipe-title" id="recipeTitle">Recipe Name</h1>
            <div class="speech-bubble" id="speechBubble">
                <p id="avatarSpeech">Hi! I'm your AI cooking assistant. Ready to cook?</p>
            </div>
            <div class="steps-carousel-wrapper">
                <div id="stepsContainer"></div>
            </div>
            <div class="controls">
                <button class="control-btn" id="startBtn" onclick="startCooking()">Start Cooking</button>
                <button class="control-btn" id="prevBtn" onclick="prevStep()" disabled>Previous Step</button>
                <button class="control-btn" id="nextBtn" onclick="nextStep()" disabled>Next Step</button>
                <button class="control-btn" id="pauseBtn" onclick="pauseTimer()" disabled style="display: none;">Pause Timer</button>
            </div>
        </div>
    </div>
    <script>
        let currentStep = 0;
        let steps = [];
        let timerInterval = null;
        let remainingSeconds = 0;
        let isPaused = false;

        function speak(text) {
            if ('speechSynthesis' in window) {
                // window.speechSynthesis.cancel(); // Removed as per user request
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9;
                window.speechSynthesis.speak(utterance);
                const avatar = document.getElementById('avatar');
                avatar.classList.add('avatar-speaking');
                utterance.onend = () => avatar.classList.remove('avatar-speaking');
            }
        }

        async function loadRecipe(recipeId) {
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('contentArea').style.display = 'none';
            try {
                const response = await fetch('/cook-with-ai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ recipe_id: parseInt(recipeId) })
                });
                const data = await response.json();
                if (data.success) {
                    steps = data.parsed_steps;
                    document.getElementById('recipeTitle').textContent = data.recipe.name;
                    displaySteps();
                    document.getElementById('loadingIndicator').style.display = 'none';
                    document.getElementById('contentArea').style.display = 'block';
                    speak(`Great! Let's cook ${data.recipe.name}. I'll guide you through ${steps.length} steps.`);
                } else {
                    alert('Error loading recipe: ' + data.error);
                }
            } catch (e) {
                console.error(e);
                alert('Error: ' + e.message);
            }
        }

        function displaySteps() {
            const container = document.getElementById('stepsContainer');
            container.innerHTML = steps.map((s, i) => `
                <div class="step-item" id="step-${i}">
                    <div class="step-number">Step ${s.step_number}</div>
                    <div>${s.text}</div>
                    ${s.has_timer && s.timers.length > 0 ? `
                        <div class="timer-badge">${s.timers[0]} min timer</div>
                        <button class="control-btn timer-start-btn" onclick="startTimer(${s.timers[0]}, ${i})">Start Timer</button>
                        <div class="step-timer" id="timer-${i}" style="display:none;">00:00</div>
                    ` : ''}
                </div>
            `).join('');
        }

        function startCooking() {
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'inline-block';
            document.getElementById('prevBtn').style.display = 'inline-block';
            currentStep = 0;
            updateStepView(false); // Don't speak on initial view
        }

        function updateStepView(shouldSpeak = true) {
            const stepsContainer = document.getElementById('stepsContainer');
            const stepItem = stepsContainer.querySelector('.step-item');
            if (!stepItem) return;
            const stepWidth = stepItem.offsetWidth;
            stepsContainer.style.transform = `translateX(-${currentStep * stepWidth}px)`;

            document.getElementById('prevBtn').disabled = currentStep === 0;
            document.getElementById('nextBtn').disabled = currentStep >= steps.length;

            if (currentStep >= steps.length) {
                speak("Congratulations! Your dish is ready!");
                document.getElementById('avatarSpeech').textContent = "Dish ready! Enjoy!";
                return;
            }

            const step = steps[currentStep];
            document.getElementById('avatarSpeech').textContent = step.text;
            if (shouldSpeak) {
                speak(step.text);
            }

            // If a timer was running for another step, clear it
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
                document.getElementById('pauseBtn').style.display = 'none';
            }
        }

        function nextStep() {
            if (currentStep < steps.length -1) { // small fix to not go beyond last step
                currentStep++;
                updateStepView();
            } else if (currentStep === steps.length -1) {
                currentStep++;
                updateStepView();
            }
        }

        function prevStep() {
            if (currentStep > 0) {
                currentStep--;
                updateStepView();
            }
        }

        function startTimer(minutes, stepIndex) {
            if (timerInterval) clearInterval(timerInterval);
            
            // Hide the start button and show the timer
            const startBtn = document.querySelector(`#step-${stepIndex} .timer-start-btn`);
            const timerEl = document.querySelector(`#step-${stepIndex} .step-timer`);
            if(startBtn) startBtn.style.display = 'none';
            if(timerEl) timerEl.style.display = 'block';

            remainingSeconds = minutes * 60;
            isPaused = false;

            const pauseBtn = document.getElementById('pauseBtn');
            pauseBtn.style.display = 'inline-block';
            pauseBtn.disabled = false;
            pauseBtn.textContent = 'Pause';
            
            speak(`Starting a ${minutes} minute timer.`);

            timerInterval = setInterval(() => {
                if (!isPaused) {
                    remainingSeconds--;
                    const mins = Math.floor(remainingSeconds / 60);
                    const secs = remainingSeconds % 60;
                    if(timerEl) timerEl.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

                    if (remainingSeconds <= 0) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                        pauseBtn.style.display = 'none';
                        pauseBtn.disabled = true;
                        speak("Timer finished!");
                        new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE=').play();
                        // Automatically move to next step after timer
                        setTimeout(nextStep, 1000);
                    }
                }
            }, 1000);
        }

        function pauseTimer() {
            isPaused = !isPaused;
            document.getElementById('pauseBtn').textContent = isPaused ? 'Resume' : 'Pause';
            if(isPaused){
                speak("Timer paused.");
            } else {
                speak("Timer resumed.");
            }
        }

        const recipeId = new URLSearchParams(window.location.search).get('recipe_id');
        if (recipeId) {
            loadRecipe(recipeId);
        } else {
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('contentArea').style.display = 'block';
            document.getElementById('avatarSpeech').textContent = "No recipe selected!";
        }
    </script>
</body>
</html>
